
<!DOCTYPE html>
<!--*************************** 
 * UCSD CSE 134B SP15
 * Authors: Andrew Wang
 *          Jonathan Ho
 *          Long Tran
 * DATE: May 31st, 2015
 ***************************-->

<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="bullion management site, rare coins, gold, silver, platinum">
    <meta name="author" content="CSE134B Dream Team">
    <link rel="stylesheet" type="text/css" href="../style/style.css">
    <meta name=viewport content="width=device-width, initial-scale=.8, minimum-scale = .8, user-scalable=yes">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <script>
var _rollbarConfig = {
    accessToken: "0e97d47296b8458584d2d9e35d2f0d49",
    captureUncaught: true,
    payload: {
        environment: "staging"
    }
};
!function(a,b){function c(b){this.shimId=++h,this.notifier=null,this.parentShim=b,this.logger=function(){},a.console&&void 0===a.console.shimId&&(this.logger=a.console.log)}function d(b,c,d){a._rollbarWrappedError&&(d[4]||(d[4]=a._rollbarWrappedError),d[5]||(d[5]=a._rollbarWrappedError._rollbarContext),a._rollbarWrappedError=null),b.uncaughtError.apply(b,d),c&&c.apply(a,d)}function e(b){var d=c;return g(function(){if(this.notifier)return this.notifier[b].apply(this.notifier,arguments);var c=this,e="scope"===b;e&&(c=new d(this));var f=Array.prototype.slice.call(arguments,0),g={shim:c,method:b,args:f,ts:new Date};return a._rollbarShimQueue.push(g),e?c:void 0})}function f(a,b){if(b.hasOwnProperty&&b.hasOwnProperty("addEventListener")){var c=b.addEventListener;b.addEventListener=function(b,d,e){c.call(this,b,a.wrap(d),e)};var d=b.removeEventListener;b.removeEventListener=function(a,b,c){d.call(this,a,b&&b._wrapped?b._wrapped:b,c)}}}function g(a,b){return b=b||this.logger,function(){try{return a.apply(this,arguments)}catch(c){b("Rollbar internal error:",c)}}}var h=0;c.init=function(a,b){var e=b.globalAlias||"Rollbar";if("object"==typeof a[e])return a[e];a._rollbarShimQueue=[],a._rollbarWrappedError=null,b=b||{};var h=new c;return g(function(){if(h.configure(b),b.captureUncaught){var c=a.onerror;a.onerror=function(){var a=Array.prototype.slice.call(arguments,0);d(h,c,a)};var g,i,j="EventTarget,Window,Node,ApplicationCache,AudioTrackList,ChannelMergerNode,CryptoOperation,EventSource,FileReader,HTMLUnknownElement,IDBDatabase,IDBRequest,IDBTransaction,KeyOperation,MediaController,MessagePort,ModalWindow,Notification,SVGElementInstance,Screen,TextTrack,TextTrackCue,TextTrackList,WebSocket,WebSocketWorker,Worker,XMLHttpRequest,XMLHttpRequestEventTarget,XMLHttpRequestUpload".split(",");for(g=0;g<j.length;++g)i=j[g],a[i]&&a[i].prototype&&f(h,a[i].prototype)}return a[e]=h,h},h.logger)()},c.prototype.loadFull=function(a,b,c,d,e){var f=g(function(){var a=b.createElement("script"),e=b.getElementsByTagName("script")[0];a.src=d.rollbarJsUrl,a.async=!c,a.onload=h,e.parentNode.insertBefore(a,e)},this.logger),h=g(function(){var b;if(void 0===a._rollbarPayloadQueue){var c,d,f,g;for(b=new Error("rollbar.js did not load");c=a._rollbarShimQueue.shift();)for(f=c.args,g=0;g<f.length;++g)if(d=f[g],"function"==typeof d){d(b);break}}"function"==typeof e&&e(b)},this.logger);g(function(){c?f():a.addEventListener?a.addEventListener("load",f,!1):a.attachEvent("onload",f)},this.logger)()},c.prototype.wrap=function(b,c){try{var d;if(d="function"==typeof c?c:function(){return c||{}},"function"!=typeof b)return b;if(b._isWrap)return b;if(!b._wrapped){b._wrapped=function(){try{return b.apply(this,arguments)}catch(c){throw c._rollbarContext=d()||{},c._rollbarContext._wrappedSource=b.toString(),a._rollbarWrappedError=c,c}},b._wrapped._isWrap=!0;for(var e in b)b.hasOwnProperty(e)&&(b._wrapped[e]=b[e])}return b._wrapped}catch(f){return b}};for(var i="log,debug,info,warn,warning,error,critical,global,configure,scope,uncaughtError".split(","),j=0;j<i.length;++j)c.prototype[i[j]]=e(i[j]);var k="https://d37gvrvc0wt4s1.cloudfront.net/js/v1.2/rollbar.min.js";_rollbarConfig.rollbarJsUrl=_rollbarConfig.rollbarJsUrl||k;var l=c.init(a,_rollbarConfig);l.loadFull(a,b,!1,_rollbarConfig)}(window,document);
</script>
    <script src="../js/jquery-1.11.2.min.js"></script>
    <script src="../js/Chart.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.5/firebase.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/team3.js"></script>

    <title>My Silver - CoinFlip</title>
    <!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("42eb1d8c22be63ebd9b828f7c8480669");</script><!-- end Mixpanel -->
</head>

<body>

    <script type="text/javascript">
        /* Checks for authetication. If no authentication, sends to index.html
           for authentication process */
        var ref = new Firebase("https://cse134bteam3-hw5.firebaseio.com");
        var authData = ref.getAuth();
        if(authData){

        } else {    
            document.location = "../index.html";
        }
    loadTopNav();
    </script>
    <script type="text/javascript">
    loadSideNav(2);
    </script>
    <section class="main-section">
        <section class="coin_wrapper">
            <div class="mobile-nav">
                <a href="wire2.html">
                    <svg class="icon icon-keyboard-arrow-left">
                        <symbol id="icon-keyboard-arrow-left" viewBox="0 0 1024 1024">
                            <title>keyboard-arrow-left</title>
                            <path class="path1" d="M657.707 696.96l-195.627-195.627 195.627-195.627-60.373-60.373-256 256 256 256z"></path>
                        </symbol>
                        <use xlink:href="#icon-keyboard-arrow-left"></use>
                    </svg>
                </a>
                MY SILVER
                <a href="update.html?silver">
                    <svg class="icon icon-add">
                        <symbol id="icon-add" viewBox="0 0 1024 1024">
                            <title>add</title>
                            <path class="path1" d="M810.667 554.667h-256v256h-85.333v-256h-256v-85.333h256v-256h85.333v256h256v85.333z"></path>
                        </symbol>
                        <use xlink:href="#icon-add"></use>
                    </svg>
                </a>
            </div>
            <section class="overview-panel">
                <section class="total-value">
                    <div class="total-dollars">$----.--</div>
                    <table class="current_gold">
                        <tr>
                            <td>Silver</td>
                            <td id="daily-change"></td>
                        </tr>
                        <tr>
                            <td>Portfolio</td>
                            <td id="overall-change">+-.-%</td>
                        </tr>
                    </table> 
                    <div class="total-label" id="my_gold_value">My Silver Value</div>

                </section>
                <section class="mobile-toggle">
                    <div class="mobile-toggle-button mtb-1 mobile-toggle-selected">
                        <svg class="icon icon-menu">
                            <symbol id="icon-menu" viewBox="0 0 1024 1024">
                                <title>menu</title>
                                <path class="path1" d="M128 768h768v-85.333h-768v85.333zM128 554.667h768v-85.333h-768v85.333zM128 256v85.333h768v-85.333h-768z"></path>
                            </symbol>
                            <use xlink:href="#icon-menu"></use>
                        </svg>
                    </div>
                    <div class="mobile-toggle-button mtb-2">
                        <svg class="icon icon-graph">
                            <symbol id="icon-graph" viewBox="0 -200 1424 1424">
                                <title>graph</title>
                                <path class="path1" d="M704 256h-192v640h192v-640zM960 448h-192v448h192v-448zM64 960v-128h64v-64h-64v-128h64v-64h-64v-128h64v-64h-64v-128h64v-64h-64v-128h64v-64h-128v1024h1024v-64h-960zM448 576h-192v320h192v-320z"></path>
                            </symbol>
                            <use xlink:href="#icon-graph"></use>
                        </svg>
                    </div>
                </section>
                <section class="market-status">
                    <div class="market-open"></div>
                    <div class="market-time"></div>
                </section>
                <section class="market-list">
                    <section class="market-item-header" id="current-spot">
                        Current Spot
                    </section>
                    <section class="market-item-stats">
                        <table>
                            <tr>
                                <td id="sbid">----.--</td>
                                <td id="sask">----.--</td>
                                <td id="schange" class="pos-change">+--.--</td>
                            </tr>
                            <tr>
                                <td>Bid</td>
                                <td>Ask</td>
                                <td>Change</td>
                            </tr>
                        </table>
                    </section>
                </section>
            </section>
            <section class="graph-panel">
                <section class="chart-legend">
                    <div class="legend-left-half">
                        <section class="legend-item">
                            <div class="legend-item-color" id="legend-3"></div>
                            Silver Total
                        </section> 
                    </div>
                </section>
                <section class="range-option-table">
                    <table style="width:100%">
                        <tr>
                            <td class="range-option" onclick="getAggregateData(getWeekBack()[1],getWeekBack()[0], false)"> 5 days </td>
                            <td class="range-option" onclick="getAggregateData(getMonthBack()[1],getMonthBack()[0], false)"> 1 month </td>
                            <td class="range-option" onclick="getAggregateData(getThreeMonthBack()[1], getThreeMonthBack()[0], false)"> 3 months </td>
                            <td class="range-option-end" onclick="getAggregateData(getYearBack()[1], getYearBack()[0], false)"> 1 year </td>
                        </tr>
                    </table>
                </section>
                <div class="chart-y-label">PRICE (USD)</div>
                <section class="chart-wrap">
                    <canvas id="total-chart"></canvas>
                </section>
            </section>

            <section class="my_stack">
                <table>
                    <caption>
                        <section class="label-and-search">
                            <h3>My Silver</h3>
                            <div class="stack_ctrl">
                                <a href="update.html?silver">
                                    <svg enable-background="new 0 0 24 24" height="24px" id="Layer_1" version="1.1" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <path clip-rule="evenodd" d="M22.5,14H14v8.5c0,0.276-0.224,0.5-0.5,0.5h-4C9.224,23,9,22.776,9,22.5V14H0.5  C0.224,14,0,13.776,0,13.5v-4C0,9.224,0.224,9,0.5,9H9V0.5C9,0.224,9.224,0,9.5,0h4C13.776,0,14,0.224,14,0.5V9h8.5  C22.776,9,23,9.224,23,9.5v4C23,13.776,22.776,14,22.5,14z" fill-rule="evenodd" fill="white" />
                                    </svg>
                                </a>
                            </div>
                        </section>
                    </caption>
                    <thead>
                        <tr>
                            <th class="stack_img_col">Image</th>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th class="weight_compr"><span>Price</span></th>
                            <th class="percent_compr"><span>Premium</span></th>
                            <th>Date of Purchase</th>
                        </tr>
                    </thead>
                    <tbody class="sTable">
                    </tbody>
                </table>
            </section>
        </section>
    </section>
    <script type="text/javascript">
        loadFooter();
        /**************************************
         * updateMarketStatus() :
         *
         * Function used to track a timer for COMEX business hours
         */
        function updateMarketStatus(){
            var currTime = new Date();
            var openTime = (new Date()).setHours(05, 20, 00, 0);
            var closeTime = (new Date()).setHours(10, 30, 00, 0);
            if(currTime.getDay() == 6 || currTime.getDay() == 0){
                $('.market-open').html("Market is closed");
                $('.market-time').html("");
            } else {
                if(currTime > openTime && currTime < closeTime){
                    $('.market-open').html("Market is open");
                    var secondsLeft = Math.round((closeTime - currTime)/1000);
                    var hours = parseInt(secondsLeft / 3600) % 24;
                    var minutes = parseInt(secondsLeft / 60) % 60;
                    var seconds = secondsLeft % 60;
                    $('.market-time').html("<i>" + hours.toString() + "h" + minutes.toString() + "m" + seconds.toString() + "s before close <i>");
                } else {
                    $('.market-open').html("Market is closed");
                    $('.market-time').html("");

                }
            }
        }

        // Kick off countdown
        updateMarketStatus();
        setInterval(updateMarketStatus, 1000);

        // Kick off live stream
        retrieveCurrentMetalsPrices(['SI.CMX', 'GC.CMX', 'PLM15.NYM']);

        // Query coin data from Firebase back-end using auth UID.
        new Firebase("https://cse134bteam3-hw5.firebaseio.com").child("users").child((new Firebase("https://cse134bteam3-hw5.firebaseio.com")).getAuth().uid).on("value", function(data){ 
            var total_price = 0.0;
            if(data.val() !== null){ // Check if there are coins. No sense aggregating no coins
                for(itemIter in data.val()['silver']){
                    total_price = total_price + parseFloat(data.val()['silver'][itemIter]['price']) * parseFloat(data.val()['silver'][itemIter]['qty']);
                    
                    // Append row to table for coin entry
                    $(".sTable").append(
                            "<tr onclick='document.location = \"wire4.html?" + itemIter + "&silver\";'>\
                                <td class='stack_img_col'><img src=\"" + data.val()['silver'][itemIter]['frnt'] + "\" + alt=\"N/A\" class=\"coin_img\"></td>\
                                <td>" + data.val()['silver'][itemIter]['name'] + "</td>\
                                <td>"+data.val()['silver'][itemIter]['qty']+"</td>\
                                <td>"+data.val()['silver'][itemIter]['price']+"</td>\
                                <td>"+data.val()['silver'][itemIter]['pre']+"</td>\
                                <td>"+data.val()['silver'][itemIter]['pdate']+"</td>\
                            </tr>\
                    "); 
                }   
            }
            $(".total-dollars").html("$" + roundResults(total_price, 2));
         });

        // Keep live stream alive
        setInterval(function(){retrieveCurrentMetalsPrices(['GC.CMX', 'SI.CMX', 'PLM15.NYM']);}, 10000);
        
        /**************************************
         * updateLiveFields(sync) :
         * 
         * Update fields of live feed to reflect changes:
         *  - sync: data that syncs to feed
         */
        function updateLiveFields(sync){
            // Update silver elements
            document.getElementById("sbid").innerHTML = sync['SI.CMX']['bid'];
            document.getElementById("sask").innerHTML = sync['SI.CMX']['ask'];
            document.getElementById("schange").innerHTML = sync['SI.CMX']['change'];
            $("#daily-change").html(sync['SI.CMX']['changePercent']);
            (sync['SI.CMX']['changePercent'].substring(0,1) == '+') ? $("#daily-change").attr("class", "pos-change") : $("#daily-change").attr("class", "neg-change");
            (sync['SI.CMX']['change'].substring(0,1) == '+') ? document.getElementById("schange").setAttribute("class", "pos-change") : document.getElementById("schange").setAttribute("class", "neg-change")

            // Query firebase for data on coins to provide overview data
            new Firebase("https://cse134bteam3-hw5.firebaseio.com").child("users").child((new Firebase("https://cse134bteam3-hw5.firebaseio.com")).getAuth().uid).on("value", function(data){ 
                var overall_change = 0.0;
                var total_priceS = 0.0;
                var total_priceP = 0.0;
                var total_priceG = 0.0;

                if(data.val()){
                    for(itemIter in data.val()['silver']){
                        total_priceS = total_priceS + parseFloat(data.val()['silver'][itemIter]['price'])*parseFloat(data.val()['silver'][itemIter]['qty']);
                    }
             
                    for(itemIter in data.val()['gold']){
                        total_priceG = total_priceG + parseFloat(data.val()['gold'][itemIter]['price'])*parseFloat(data.val()['gold'][itemIter]['qty']);
                    }   
                
                    for(itemIter in data.val()['platinum']){
                        total_priceP = total_priceP + parseFloat(data.val()['platinum'][itemIter]['price'])*parseFloat(data.val()['platinum'][itemIter]['qty']);
                    } 
                }
                if((total_priceS > 0) || (total_priceP > 0) || (total_priceG > 0)){
                    overall_change = (total_priceS / (total_priceS + total_priceP + total_priceG)) *parseFloat(sync['SI.CMX']['changePercent'].substring(1, sync['SI.CMX']['changePercent'].length - 2))
                                * ((sync['SI.CMX']['changePercent'].substring(0, 1) == '+') ? (1.0) : (-1.0))
                            + (total_priceG / (total_priceS + total_priceP + total_priceG)) *parseFloat(sync['GC.CMX']['changePercent'].substring(1, sync['GC.CMX']['changePercent'].length - 2))
                                * ((sync['GC.CMX']['changePercent'].substring(0, 1) == '+') ? (1.0) : (-1.0))
                            + (total_priceP / (total_priceS + total_priceP + total_priceG)) *parseFloat(sync['PLM15.NYM']['changePercent'].substring(1, sync['PLM15.NYM']['changePercent'].length - 2))
                                * ((sync['PLM15.NYM']['changePercent'].substring(0, 1) == '+') ? (1.0) : (-1.0));
                }
                overall_change = (overall_change >= 0.0 ? '+' : '').toString() + roundResults(overall_change, 3) + "%";
                $("#overall-change").html(overall_change);
                (overall_change >= 0.0) ? $("#overall-change").attr("class", "pos-change") : $("#overall-change").attr("class", "neg-change");
            });
            mixpanel.track("update live fields");
        }

        /**************************************
         * receiveAggregateData(data) :
         *
         * Callback of aggregate data to graph aggregated data
         *  - data: data to be graphed
         */        
        function receiveAggregateData(data){
            drawGraph(data);
        }
    </script>
</body>

</html>
